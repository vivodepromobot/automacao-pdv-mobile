name: Testes Mobile Automatizados

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Filtro de testes (ex: venda, troca, pedido)'
        required: false
        default: ''

env:
  TEST_SERVER_IP: ${{ secrets.TEST_SERVER_IP }}
  TEST_SERVER_PORT: ${{ secrets.TEST_SERVER_PORT }}
  TEST_COMPANY: ${{ secrets.TEST_COMPANY }}
  TEST_USER: ${{ secrets.TEST_USER }}
  TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
  CI: true

jobs:
  testes-mobile:
    runs-on: ubuntu-latest
    timeout-minutes: 45 # Aumentei um pouco por seguran√ßa

    steps:
      - name: üì• Baixar c√≥digo
        uses: actions/checkout@v4

      # 1. Configura√ß√µes de Ambiente (Python e Node)
      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üì¶ Instalar Depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: üü¢ Configurar Node.js e Appium
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üîß Instalar Appium e Drivers
        run: |
          npm install -g appium
          appium driver install uiautomator2

      # 2. Otimiza√ß√£o de Hardware para o Emulador
      - name: ‚ö° Habilitar KVM (Acelera√ß√£o)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      # 3. A M√°gica: Subir Emulador e Rodar Testes
      - name: üì± Executar Testes no Emulador Android
        uses: reactivecircus/android-emulator-runner@v2
        with:
          # Configura√ß√µes Leves para CI (Evita Timeout)
          api-level: 29
          target: google_apis
          arch: x86_64
          profile: Nexus 5
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          emulator-boot-timeout: 600 # 10 minutos de paci√™ncia para o boot
          
          # O script que roda DENTRO do ambiente com emulador ligado
          script: |
            # 1. Inicia o Appium em Background e salva o PID
            echo "üîß Iniciando Appium..."
            appium --relaxed-security --log-level error > appium.log 2>&1 &
            APPIUM_PID=$!
            
            # 2. Aguarda o Appium estar pronto (check de sa√∫de)
            echo "‚è≥ Aguardando Appium..."
            sleep 10
            
            # 3. Prepara o filtro de teste (se houver)
            TEST_FILTER="${{ github.event.inputs.test_filter }}"
            echo "üß™ Iniciando Pytest (Filtro: $TEST_FILTER)..."
            
            # 4. Executa os testes
            if [ -n "$TEST_FILTER" ]; then
              pytest tests/ -v -s -k "$TEST_FILTER" --alluredir=allure-results
            else
              pytest tests/ -v -s --alluredir=allure-results
            fi
            
            # (O Appium morre sozinho quando o container fecha, n√£o precisa matar manual)

      # 4. Relat√≥rios e Artefatos (Sempre roda, mesmo se falhar)
      - name: üìä Gerar Relat√≥rio Allure
        if: always()
        run: |
          # Instala o Allure Commandline (Java tool)
          sudo apt-get install -y allure
          allure generate allure-results --clean -o allure-report

      - name: üíæ Salvar Relat√≥rio como Artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-allure
          path: allure-report

      - name: üì∏ Salvar Logs e Prints de Erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-erros
          path: |
            logs/
            appium.log
